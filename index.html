<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediBot - AI Medical Assistant</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Custom scrollbar for chat */
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 4px;
        }
        .dark #chat-window::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="dark bg-slate-50 dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 min-h-screen">

    <!-- Global App Container -->
    <div id="app-container">
        
        <!-- HEADER -->
        <header class="border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-[#0f172a]/95 backdrop-blur sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center gap-2">
    <img src="mediguide-logo.png"
         alt="MediGuide+ logo"
         class="w-10 h-10 rounded-lg" />
    <span class="text-2xl font-bold text-slate-800 dark:text-emerald-400 tracking-tight">
        MediGuide+
    </span>
</div>
                
                <!-- Desktop Nav -->
                <nav class="hidden md:flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 transition-colors">
                        <!-- Sun/Moon Icon will be injected by JS -->
                    </button>

                    <button onclick="clearSearchAndResetView()" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <span>Search</span>
                    </button>
                    
                    <a href="https://www.google.com/maps/search/nearby+medical+shops" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span>Nearby Shops</span>
                    </a>

                    <button onclick="toggleScannerModal(true)" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-emerald-50 dark:bg-transparent hover:bg-emerald-100 dark:hover:bg-slate-800 text-emerald-600 dark:text-emerald-400 transition-colors font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 7h4"/><path d="M15 7h4"/><rect x="5" y="10" width="14" height="11" rx="2"/><path d="M12 15V19"/><path d="M12 21h2"/><path d="M12 21h-2"/></svg>
                        <span>Scan Medicine</span>
                    </button>
                </nav>
                
                <!-- Mobile Actions -->
                <div class="flex items-center gap-2 md:hidden">
                    <button id="mobile-theme-toggle" class="p-2 text-slate-600 dark:text-slate-300">
                        <!-- Sun/Moon Icon will be injected by JS -->
                    </button>
                    <button onclick="toggleScannerModal(true)" class="p-2 text-emerald-600 dark:text-emerald-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 7h4"/><path d="M15 7h4"/><rect x="5" y="10" width="14" height="11" rx="2"/><path d="M12 15V19"/><path d="M12 21h2"/><path d="M12 21h-2"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="max-w-7xl mx-auto px-4 py-12 pb-24">
            <div id="main-content">
                <!-- Content will be rendered here (Hero or Details) -->
            </div>
        </main>

        <!-- FLOATING CHAT BUTTON -->
        <div id="chat-button-container" class="fixed bottom-6 right-6 z-50">
            <!-- Chat button or Chat window will be rendered here -->
        </div>

        <!-- SCANNER MODAL -->
        <div id="scanner-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 items-center justify-center p-4 hidden">
            <!-- Modal content will be rendered here -->
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        // NOTE: The API key is managed by the environment
        const API_KEY = "AIzaSyDfeUZ-biw8lq3poxKctu7tDsxmjIbxfK4"; 

        const SYSTEM_PROMPT = `
You are MediBot, a medical information AI assistant. 

CORE RESPONSIBILITIES:

1. SEARCH SUGGESTIONS
- Trigger: User types into search bar.
- Action: Return relevant medicine names and generics based on the query.
- Output: STRICT JSON Array: [{"name": "Brand", "generic": "Generic"}]

2. MEDICINE DETAILS (From Text Search OR Image Analysis)
- Trigger: User selects medicine OR uploads/captures image.
- Action: Identify medicine and provide comprehensive details.
- Output: STRICT JSON Object:
  {
    "name": "Medicine Name",
    "genericName": "Generic/Scientific name",
    "activeIngredients": "List of active ingredients with quantities",
    "indications": "Medical uses and conditions it treats",
    "dosageForms": "Available forms and strengths",
    "commonSideEffects": "List of common side effects",
    "contraindications": "Conditions/situations when NOT to use",
    "manufacturer": "Known manufacturers",
    "priceRange": "Approx. price (INR/USD)",
    "warnings": "Important warnings",
    "alternatives": ["Alt 1", "Alt 2", "Alt 3"]
  }

3. CHATBOT
- Safety: ALWAYS include disclaimers. NEVER diagnose.
- Output: Plain text.

CRITICAL: 
- If an image is provided, recognize the medicine package/pill and return the full detailed JSON object for this medicine (name, ingredients, sideEffects, etc) as per the schema. If not a medicine, return empty JSON.
`;
        
        // --- APP STATE ---
        let appState = {
            isDarkMode: true,
            query: '',
            suggestions: [],
            selectedMedicine: null, // Holds the detailed medicine object
            loading: false,
            loadingSuggestions: false,
            isChatOpen: false,
            chatHistory: [{ role: 'assistant', text: "Hello! I'm MediBot. Ask me medical questions, search for medicines, or scan a package for details." }],
            chatInput: '',
            chatLoading: false,
            showScannerModal: false,
            isCameraActive: false,
            debounceTimer: null,
            videoStream: null,
            // Track previous states to avoid unnecessary rendering (Crucial for the fix)
            prevSuggestionVisibility: false, 
        };

        // --- UTILITY ICONS (Lucide SVGs) ---
        const Icons = {
            Search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
            MapPin: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
            Camera: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 7h4"/><path d="M15 7h4"/><rect x="5" y="10" width="14" height="11" rx="2"/><path d="M12 15V19"/><path d="M12 21h2"/><path d="M12 21h-2"/></svg>`,
            MessageCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20.3L4 22l-.8-2.6A9 9 0 0 1 2 12C2 6.5 6.5 2 12 2s10 4.5 10 10-4.5 10-10 10c-.3 0-.7 0-1-.1z"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>`,
            Upload: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
            ChevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>`,
            AlertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            Activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
            Pill: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.5 4.5l9 9"/><path d="M18.5 6.5l-9 9"/><path d="M11.5 20.5l-8-8c-2.4-2.4-2.4-6.2 0-8.5 2.4-2.4 6.2-2.4 8.5 0l8 8"/><path d="M5 5l2 2"/></svg>`,
            ShieldAlert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>`,
            Send: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>`,
            Loader2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.21-8.54"/></svg>`,
            Moon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            Sun: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M6.34 17.66l-1.41 1.41"/><path d="M19.07 4.93l-1.41 1.41"/></svg>`,
            Aperture: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="m20.5 8.5-1.9.9"/><path d="m16.5 21.5-1.9-.9"/><path d="M7.4 20l-1.9-1.9"/><path d="M3.5 15.5 5.4 14.6"/><path d="M3.5 8.5l1.9-.9"/><path d="M7.4 4l1.9 1.9"/><path d="m15 2.5 1.9.9"/><path d="m20 15-1.9 1.9"/></svg>`,
        };

        // --- API CALLER ---
        const callGeminiAPI = async (prompt, imageBase64 = null, jsonMode = false) => {
            const url = `${API_BASE_URL}?key=${API_KEY}`;
            const contents = [
                {
                    role: "user",
                    parts: [
                        { text: prompt },
                        ...(imageBase64 ? [{ inlineData: { mimeType: "image/png", data: imageBase64 } }] : [])
                    ]
                }
            ];

            const payload = {
                contents,
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                generationConfig: jsonMode ? { responseMimeType: "application/json" } : {}
            };

            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < 2) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                            continue; // Retry
                        }
                        throw new Error(`API Error: ${response.status} - ${await response.text()}`);
                    }
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
                } catch (error) {
                    console.error(`Gemini API Error on attempt ${attempt + 1}:`, error);
                    if (attempt < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            return null; // All retries failed
        };

        // --- CORE UI RENDERING & STATE MANAGEMENT ---

        /**
         * Updates the application state and optionally triggers a UI re-render.
         * @param {object} newState - The partial state to merge.
         * @param {boolean} [shouldUpdateUI=true] - Whether to call updateUI() after merging state.
         */
        function setAppState(newState, shouldUpdateUI = true) {
            appState = { ...appState, ...newState };
            if (shouldUpdateUI) {
                updateUI();
            } else {
                // If not updating full UI, check if only search/suggestion elements need update
                updateSearchUI();
            }
        }

        function toggleTheme() {
            setAppState({ isDarkMode: !appState.isDarkMode });
            document.body.classList.toggle('dark', appState.isDarkMode);
        }

        function clearSearchAndResetView() {
            // Must trigger full UI update
            setAppState({ selectedMedicine: null, query: '', suggestions: [], loadingSuggestions: false });
        }

        // --- SEARCH LOGIC ---
        function handleSearchInput(event) {
            const newQuery = event.target.value;
            const searchInput = document.getElementById('search-input');
            const hadSuggestionsOrLoading = appState.loadingSuggestions || appState.suggestions.length > 0;
            
            // 1. Update query state silently
            appState.query = newQuery; 
            
            // 2. IMPORTANT FIX: Update the input value directly (the browser already did this, but we confirm)
            // This prevents a full re-render from resetting the input field.
            if (searchInput) {
                searchInput.value = newQuery;
            }

            // 3. Clear debounce timer
            clearTimeout(appState.debounceTimer);
            
            // 4. Determine if we need to show/hide the suggestions box (which requires updating search UI)
            let needsSearchUIUpdate = false;

            if (newQuery.length >= 3) {
                // We need to start loading and show the loading spinner/placeholder
                if (!appState.loadingSuggestions) {
                    setAppState({ loadingSuggestions: true, suggestions: [] }, false);
                    needsSearchUIUpdate = true;
                }
                appState.debounceTimer = setTimeout(fetchSuggestions, 600);
            } else if (hadSuggestionsOrLoading) {
                 // If query is < 3 but suggestions/loading are visible, hide them
                 setAppState({ loadingSuggestions: false, suggestions: [] }, false);
                 needsSearchUIUpdate = true;
            }
            
            if (needsSearchUIUpdate) {
                updateSearchUI();
            }
        }

        async function fetchSuggestions() {
            if (appState.query.length < 3) {
                setAppState({ loadingSuggestions: false, suggestions: [] }, false);
                updateSearchUI();
                return;
            }
            
            const prompt = `User search query: "${appState.query}". Return JSON array of medicine suggestions only.`;
            const result = await callGeminiAPI(prompt, null, true);
            
            let newSuggestions = [];
            if (result) {
                try {
                    const parsed = JSON.parse(result);
                    newSuggestions = Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    console.error("Parse error for suggestions:", e);
                }
            }
            // Update state and trigger only search UI update
            setAppState({ loadingSuggestions: false, suggestions: newSuggestions }, false);
            updateSearchUI();
        }

        async function handleSelectMedicine(medicineName) {
            // This triggers a full UI render to show the loading screen
            setAppState({ query: medicineName, suggestions: [], loadingSuggestions: false, loading: true, selectedMedicine: null });

            const prompt = `User selected medicine: "${medicineName}". Provide comprehensive details in the specified JSON format.`;
            const result = await callGeminiAPI(prompt, null, true);
            
            if (result) {
                try {
                    const data = JSON.parse(result);
                    if (data.name) {
                        setAppState({ selectedMedicine: data, loading: false });
                        return;
                    } else {
                        console.warn("API returned no valid medicine data for selection.");
                        sendMessageToChatbot("I was unable to find detailed information for that medicine right now. Please try a different search or ask me in the chat.", 'assistant', false);
                    }
                } catch (e) {
                    console.error("Details parse error:", e);
                }
            }
            setAppState({ loading: false });
        }

        // --- SCANNER/IMAGE LOGIC ---

        function toggleScannerModal(show) {
            setAppState({ showScannerModal: show });
            const modal = document.getElementById('scanner-modal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                stopCamera();
            }
        }

        function stopCamera() {
            if (appState.videoStream) {
                appState.videoStream.getTracks().forEach(track => track.stop());
                setAppState({ videoStream: null, isCameraActive: false }, false); // Do not force UI update here
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                setAppState({ videoStream: stream, isCameraActive: true });
                // Video element is rendered by updateUI() after state change,
                // so we need a slight delay to ensure it exists.
                setTimeout(() => {
                    const videoElement = document.getElementById('video-stream');
                    if (videoElement) {
                        videoElement.srcObject = stream;
                        videoElement.play();
                    }
                }, 100);
            } catch (err) {
                console.error("Camera Error", err);
                sendMessageToChatbot("Unable to access your device's camera. Please check your browser permissions.", 'assistant', true);
                setAppState({ isCameraActive: false });
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video-stream');
            const canvas = document.createElement('canvas'); // Create canvas dynamically
            
            if (video) {
                // Calculate aspect ratio
                const aspectRatio = video.videoWidth / video.videoHeight;
                canvas.width = 400; 
                canvas.height = 400 / aspectRatio; 

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const base64Data = canvas.toDataURL('image/png').split(',')[1];
                processImage(base64Data);
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                const base64Data = reader.result.split(',')[1];
                processImage(base64Data);
            };
            reader.readAsDataURL(file);
        }

        async function processImage(base64Data) {
            toggleScannerModal(false); // Close modal
            stopCamera();
            setAppState({ loading: true, selectedMedicine: null });

            const prompt = "Analyze this image. Identify the medicine. If found, return the full detailed JSON object for this medicine (name, ingredients, sideEffects, etc) as per the schema. If not a medicine, return empty JSON.";
            const result = await callGeminiAPI(prompt, base64Data, true);
            
            if (result) {
                try {
                    const data = JSON.parse(result);
                    if (data.name) {
                        setAppState({ selectedMedicine: data, loading: false });
                        return;
                    } else {
                        sendMessageToChatbot("I couldn't identify a medicine package in that image. Please ensure the label is clear and try again.", 'assistant', true);
                    }
                } catch (e) {
                    console.error("Image parse error", e);
                    sendMessageToChatbot("Error analyzing image data. The AI may have returned an unexpected format. Please try again.", 'assistant', true);
                }
            } else {
                sendMessageToChatbot("A communication error occurred with the AI. Please check your connection and try again.", 'assistant', true);
            }
            setAppState({ loading: false });
        }


        // --- CHAT LOGIC ---

        function handleChatInput(event) {
            // Update input state silently
            setAppState({ chatInput: event.target.value }, false); 
        }

        async function handleSendMessage(event) {
            event.preventDefault();
            if (!appState.chatInput.trim()) return;

            const userMessage = appState.chatInput.trim();
            const newHistory = [...appState.chatHistory, { role: 'user', text: userMessage }];

            // Update state and UI (shows loading spinner/updates chat)
            setAppState({ chatHistory: newHistory, chatInput: '', chatLoading: true, isChatOpen: true });
            
            const prompt = `User Question: "${userMessage}". Previous Context: ${JSON.stringify(newHistory.slice(-2))}. Answer accurately but concisely with safety disclaimers.`;
            const responseText = await callGeminiAPI(prompt, null, false);
            
            const finalResponse = responseText || "I'm sorry, I couldn't process that request right now due to a network or API error.";
            
            // Update state and UI (shows new message)
            setAppState({ 
                chatHistory: [...newHistory, { role: 'assistant', text: finalResponse }], 
                chatLoading: false 
            });

             // Scroll to bottom of chat
            setTimeout(() => {
                const chatWindow = document.getElementById('chat-window');
                if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 100);
        }

        function sendMessageToChatbot(message, role, openChat) {
             const newHistory = [...appState.chatHistory, { role: role, text: message }];
             setAppState({ chatHistory: newHistory, isChatOpen: openChat });
        }

        // --- RENDERING FUNCTIONS (DOM MANIPULATION) ---

        const renderIcon = (iconName, classes) => {
            const svg = Icons[iconName] || '';
            return `<span class="${classes}">${svg}</span>`;
        };

        function renderDetailCard(iconName, title, content, warning = false) {
            const iconSvg = renderIcon(iconName, `w-5 h-5 ${warning ? 'text-red-500 dark:text-red-400' : 'text-emerald-600 dark:text-emerald-400'}`);
            
            return `
                <div class="p-5 rounded-xl border shadow-sm transition-all hover:shadow-md ${
                    warning 
                    ? 'bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-500/30' 
                    : 'bg-white dark:bg-slate-800/50 border-slate-200 dark:border-slate-700'
                }">
                    <div class="flex items-center gap-2 mb-3">
                        ${iconSvg}
                        <h3 class="font-bold ${warning ? 'text-red-700 dark:text-red-300' : 'text-slate-700 dark:text-slate-200'}">${title}</h3>
                    </div>
                    <p class="text-sm leading-relaxed ${warning ? 'text-red-800 dark:text-red-200' : 'text-slate-600 dark:text-slate-300'}">
                        ${content || "Information not available"}
                    </p>
                </div>
            `;
        }

        function renderDetailsView() {
            const m = appState.selectedMedicine;
            if (!m) return '';

            const alternativesHtml = m.alternatives?.length > 0 ? `
                <div class="mt-8 pt-8 border-t border-slate-100 dark:border-slate-700">
                    <h3 class="text-slate-500 dark:text-slate-400 font-bold mb-4 text-xs uppercase tracking-wider">Known Alternatives</h3>
                    <div class="flex flex-wrap gap-3">
                        ${m.alternatives.map((alt, i) => `
                            <button onclick="handleSelectMedicine('${alt}')" class="flex items-center gap-1 px-3 py-1 rounded-lg border border-emerald-500/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-500/10 font-medium">
                                ${alt} ${renderIcon('ChevronRight', 'w-3 h-3')}
                            </button>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            return `
                <div class="animate-in slide-in-from-bottom-8 fade-in duration-500">
                    <button onclick="clearSearchAndResetView()" class="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors">
                        ${renderIcon('X', 'w-4 h-4')} Back to Search
                    </button>

                    <div class="bg-white dark:bg-[#1e293b] rounded-3xl p-6 md:p-8 border border-slate-200 dark:border-slate-700 shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between md:items-start gap-6 mb-8 border-b border-slate-100 dark:border-slate-700 pb-8">
                            <div>
                                <h2 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-2">${m.name}</h2>
                                <p class="text-emerald-600 dark:text-emerald-400 text-lg font-medium">${m.genericName}</p>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">${m.manufacturer}</span>
                                    <span class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">${m.priceRange}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 bg-emerald-50 dark:bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 px-4 py-2 rounded-full border border-emerald-100 dark:border-emerald-500/20">
                                ${renderIcon('Activity', 'w-5 h-5')}
                                <span class="font-bold">Verified Info</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${renderDetailCard('Pill', 'Indications (Uses)', m.indications)}
                            ${renderDetailCard('Activity', 'Active Ingredients', m.activeIngredients)}
                            ${renderDetailCard('FileText', 'Dosage Forms', m.dosageForms)}
                            ${renderDetailCard('AlertTriangle', 'Side Effects', m.commonSideEffects, true)}
                            ${renderDetailCard('ShieldAlert', 'Contraindications', m.contraindications, true)}
                            ${renderDetailCard('AlertTriangle', 'Warnings', m.warnings, true)}
                        </div>
                        ${alternativesHtml}
                    </div>
                </div>
            `;
        }

        function renderSuggestionsDropdown() {
            const isVisible = appState.loadingSuggestions || appState.suggestions.length > 0;
            if (!isVisible) return '';

            // Render loading spinner if fetching
            if (appState.loadingSuggestions) {
                return `
                    <div class="flex items-center justify-center p-4 text-slate-500 dark:text-slate-400">
                         ${renderIcon('Loader2', 'w-5 h-5 text-emerald-500 animate-spin mr-2')} Loading Suggestions...
                    </div>
                `;
            }
            
            // Render suggestions
            return `
                ${appState.suggestions.map((drug, idx) => `
                    <button
                        key="${idx}"
                        onclick="handleSelectMedicine('${drug.name}')"
                        class="w-full flex flex-col items-start px-6 py-4 hover:bg-slate-50 dark:hover:bg-slate-800 border-b border-slate-100 dark:border-slate-800/50 last:border-0 transition-colors text-left"
                    >
                        <span class="font-semibold text-emerald-600 dark:text-emerald-400">${drug.name}</span>
                        <span class="text-sm text-slate-500 dark:text-slate-400">${drug.generic}</span>
                    </button>
                `).join('')}
            `;
        }
        
        function updateSearchUI() {
            const searchContainer = document.getElementById('search-container');
            if (!searchContainer) return; // Prevent errors if we're not in the hero view

            // 1. Update the loading spinner in the input
            const loadingIconContainer = document.getElementById('loading-icon-container');
            if (loadingIconContainer) {
                loadingIconContainer.innerHTML = appState.loadingSuggestions 
                    ? renderIcon('Loader2', 'w-5 h-5 text-emerald-500 animate-spin') 
                    : '';
            }

            // 2. Update the suggestions dropdown
            const suggestionsContainer = document.getElementById('suggestions-container');
            const isVisible = appState.loadingSuggestions || appState.suggestions.length > 0;
            
            // Only update the innerHTML if visibility status has changed (to avoid unnecessary DOM work)
            if (suggestionsContainer) {
                 if (isVisible) {
                    suggestionsContainer.innerHTML = renderSuggestionsDropdown();
                    suggestionsContainer.classList.remove('hidden');
                    // Add fade-in effect when becoming visible
                    if (!appState.prevSuggestionVisibility) {
                         suggestionsContainer.classList.add('animate-in', 'fade-in', 'slide-in-from-top-2');
                    }
                 } else {
                    suggestionsContainer.classList.add('hidden');
                    suggestionsContainer.innerHTML = '';
                 }
            }
            appState.prevSuggestionVisibility = isVisible;
        }


        function renderHeroSection() {
            const quickActions = ['Paracetamol', 'Ibuprofen', 'Cetirizine', 'Aspirin'].map(med => `
                <button 
                    onclick="handleSelectMedicine('${med}')"
                    class="px-5 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-full text-sm font-medium text-slate-600 dark:text-slate-300 hover:border-emerald-500 hover:text-emerald-500 transition-colors shadow-sm"
                >
                    ${med}
                </button>
            `).join('');

            return `
                <div class="text-center mb-16 fade-in">
                    <h1 class="text-4xl md:text-6xl font-bold mb-6 text-slate-900 dark:text-white">
                        Find <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-teal-400">Medicine</span> Info
                    </h1>
                    <p class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto mb-12">
                        Instantly identify medicines by name or photo. Get dosages, side effects, and safe alternatives powered by AI.
                    </p>

                    <!-- SEARCH BAR CONTAINER (Fixed to prevent input flicker) -->
                    <div id="search-container" class="relative max-w-3xl mx-auto group">
                        <div class="absolute inset-0 bg-emerald-500/10 blur-xl rounded-full group-hover:bg-emerald-500/20 transition-all"></div>
                        <div class="relative flex items-center bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-2xl shadow-xl dark:shadow-none focus-within:border-emerald-500/50 transition-colors">
                            ${renderIcon('Search', 'w-6 h-6 text-slate-400 ml-6')}
                            <input 
                                type="text" 
                                id="search-input"
                                value="${appState.query}"
                                placeholder="Search medicine (e.g., Dolo, Amoxicillin)..."
                                class="w-full bg-transparent border-none px-6 py-5 text-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-0"
                                oninput="handleSearchInput(event)"
                            />
                            <div id="loading-icon-container" class="pr-6">
                                <!-- Loading icon will be injected by updateSearchUI -->
                                ${appState.loadingSuggestions ? renderIcon('Loader2', 'w-5 h-5 text-emerald-500 animate-spin') : ''}
                            </div>
                        </div>
                        
                        <!-- SUGGESTIONS CONTAINER (Updated independently) -->
                        <div id="suggestions-container" class="absolute top-full left-0 right-0 mt-4 bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl overflow-hidden z-30 ${appState.loadingSuggestions || appState.suggestions.length > 0 ? '' : 'hidden'}">
                            ${renderSuggestionsDropdown()}
                        </div>
                    </div>

                    <!-- QUICK ACTIONS -->
                    <div class="flex flex-wrap justify-center gap-3 mt-12">
                        ${quickActions}
                    </div>
                </div>
            `;
        }

        function renderLoadingState() {
            return `
                <div class="flex flex-col items-center justify-center py-20 animate-in fade-in">
                    <div class="relative">
                        <div class="absolute inset-0 bg-emerald-500 blur-xl opacity-20 animate-pulse rounded-full"></div>
                        ${renderIcon('Loader2', 'relative w-16 h-16 text-emerald-500 animate-spin')}
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 mt-6 animate-pulse font-medium">Analyzing medical database...</p>
                </div>
            `;
        }

        function renderChatWindow() {
            if (!appState.isChatOpen) {
                return `
                    <button 
                        onclick="setAppState({ isChatOpen: true })"
                        class="bg-emerald-500 hover:bg-emerald-600 text-white p-4 rounded-full shadow-lg shadow-emerald-500/30 transition-all hover:scale-110 active:scale-95 flex items-center justify-center"
                    >
                        ${renderIcon('MessageCircle', 'w-7 h-7')}
                    </button>
                `;
            }

            const messagesHtml = appState.chatHistory.map(msg => `
                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="max-w-[85%] rounded-2xl px-5 py-3 shadow-sm ${
                        msg.role === 'user' 
                        ? 'bg-emerald-600 text-white rounded-br-none' 
                        : 'bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 border border-slate-200 dark:border-slate-600 rounded-bl-none'
                    }">
                        <p class="text-sm leading-relaxed">${msg.text}</p>
                    </div>
                </div>
            `).join('');

            const loadingHtml = appState.chatLoading ? `
                <div class="flex justify-start">
                    <div class="bg-white dark:bg-slate-700 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm">
                        ${renderIcon('Loader2', 'w-4 h-4 animate-spin text-slate-400')}
                    </div>
                </div>
            ` : '';

            return `
                <div class="bg-white dark:bg-[#1e293b] border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl w-[90vw] md:w-[400px] h-[500px] flex flex-col animate-in slide-in-from-bottom-10 fade-in">
                    <!-- Chat Header -->
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50 rounded-t-2xl">
                        <div class="flex items-center gap-3">
                            <div class="bg-emerald-100 dark:bg-emerald-500/20 p-2 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-600 dark:text-emerald-400"><path d="M12 11a4 4 0 0 0 4-4V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v4a4 4 0 0 0 4 4z"/><path d="M18 10a1 1 0 0 0-1 1v7c0 2.2-1.8 4-4 4H9c-2.2 0-4-1.8-4-4v-7a1 1 0 0 0-1-1h-.5a.5.5 0 0 0-.5.5v3a1 1 0 0 0 1 1h.5a.5.5 0 0 0 .5-.5v-3.5"/><path d="M22 10.5v3a1 1 0 0 1-1 1h-.5a.5.5 0 0 1-.5-.5v-3.5"/><path d="M4 10.5v3a1 1 0 0 0 1 1h.5a.5.5 0 0 0 .5-.5v-3.5"/></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-white">MediBot Assistant</h3>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Always consult a doctor</p>
                            </div>
                        </div>
                        <button onclick="setAppState({ isChatOpen: false })" class="text-slate-400 hover:text-slate-600 dark:hover:text-white">
                            ${renderIcon('X', 'w-5 h-5')}
                        </button>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-[#0f172a]/50">
                        ${messagesHtml}
                        ${loadingHtml}
                    </div>

                    <!-- Chat Input -->
                    <form onsubmit="handleSendMessage(event)" class="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 rounded-b-2xl">
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                value="${appState.chatInput}"
                                oninput="handleChatInput(event)"
                                placeholder="Ask a medical question..."
                                class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:border-emerald-500"
                                ${appState.chatLoading ? 'disabled' : ''}
                            />
                            <button 
                                type="submit"
                                ${appState.chatLoading ? 'disabled' : ''}
                                class="bg-emerald-500 hover:bg-emerald-600 text-white p-2 rounded-xl transition-colors disabled:opacity-50"
                            >
                                ${renderIcon('Send', 'w-5 h-5')}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderScannerModal() {
            if (!appState.showScannerModal) return '';

            const cameraContent = appState.isCameraActive ? `
                <div class="relative bg-black rounded-xl overflow-hidden aspect-[3/4]">
                    <video id="video-stream" autoplay playsinline class="w-full h-full object-cover"></video>
                    
                    <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                        <button 
                            onclick="stopCamera(); setAppState({}, true);"
                            class="p-3 rounded-full bg-slate-800/80 text-white backdrop-blur-sm"
                        >
                            ${renderIcon('X', 'w-6 h-6')}
                        </button>
                        <button 
                            onclick="capturePhoto()"
                            class="p-4 rounded-full bg-white border-4 border-emerald-500 shadow-lg transform active:scale-95 transition-transform"
                        >
                            <div class="w-4 h-4 rounded-full bg-emerald-500"></div>
                        </button>
                    </div>
                </div>
            ` : `
                <div class="grid grid-cols-2 gap-4">
                    <!-- Option 1: Camera -->
                    <button 
                        onclick="startCamera()"
                        class="flex flex-col items-center justify-center gap-3 p-6 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-emerald-500 hover:bg-emerald-50 dark:hover:bg-slate-800 transition-all group"
                    >
                        <div class="p-3 bg-slate-100 dark:bg-slate-800 rounded-full group-hover:bg-emerald-100 dark:group-hover:bg-emerald-500/20 transition-colors">
                            ${renderIcon('Aperture', 'w-8 h-8 text-slate-500 dark:text-slate-400 group-hover:text-emerald-600 dark:group-hover:text-emerald-400')}
                        </div>
                        <span class="font-semibold text-slate-700 dark:text-slate-300">Take Photo</span>
                    </button>

                    <!-- Option 2: Upload -->
                    <div class="relative flex flex-col items-center justify-center gap-3 p-6 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-600 hover:border-emerald-500 hover:bg-emerald-50 dark:hover:bg-slate-800 transition-all group cursor-pointer">
                        <input 
                            type="file" 
                            accept="image/*"
                            onchange="handleFileUpload(event)"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        />
                        <div class="p-3 bg-slate-100 dark:bg-slate-800 rounded-full group-hover:bg-emerald-100 dark:group-hover:bg-emerald-500/20 transition-colors">
                            ${renderIcon('Upload', 'w-8 h-8 text-slate-500 dark:text-slate-400 group-hover:text-emerald-600 dark:group-hover:text-emerald-400')}
                        </div>
                        <span class="font-semibold text-slate-700 dark:text-slate-300">Upload Image</span>
                    </div>
                </div>
            `;

            const modal = document.getElementById('scanner-modal');
            modal.style.display = 'flex'; // Ensure it's visible when rendering

            return `
                <div class="bg-white dark:bg-[#1e293b] rounded-2xl w-full max-w-md p-6 border border-slate-200 dark:border-slate-700 shadow-2xl relative overflow-hidden">
                    <button 
                        onclick="toggleScannerModal(false)"
                        class="absolute top-4 right-4 z-10 p-1 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:text-slate-800 dark:hover:text-white"
                    >
                        ${renderIcon('X', 'w-5 h-5')}
                    </button>
                    
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Scan Medicine</h3>
                    <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">
                        Identify medicine by taking a photo or uploading an image.
                    </p>
                    ${cameraContent}
                </div>
            `;
        }

        function updateUI() {
            // 1. Set Dark Mode class on body
            document.body.classList.toggle('dark', appState.isDarkMode);

            // 2. Render Main Content (Hero, Loading, or Details)
            const mainContent = document.getElementById('main-content');
            
            // Only capture focus if we are about to re-render the Hero section
            const searchInput = document.getElementById('search-input');
            const currentQuery = searchInput ? searchInput.value : appState.query;
            let shouldReRenderHero = true;

            if (appState.loading) {
                mainContent.innerHTML = renderLoadingState();
                shouldReRenderHero = false;
            } else if (appState.selectedMedicine) {
                mainContent.innerHTML = renderDetailsView();
                shouldReRenderHero = false;
            } else {
                // If we are already in the Hero section, don't re-render the whole thing 
                // just because the chat state or theme changed. This ensures the input stays stable.
                if (mainContent.querySelector('#search-container')) {
                     shouldReRenderHero = false;
                } else {
                     mainContent.innerHTML = renderHeroSection();
                }
            }

            if (shouldReRenderHero) {
                // Re-attach the listener and restore query if the hero section was re-rendered
                const newlyRenderedSearchInput = document.getElementById('search-input');
                if (newlyRenderedSearchInput) {
                    newlyRenderedSearchInput.oninput = handleSearchInput;
                    // Ensure the query value is correct after re-render
                    newlyRenderedSearchInput.value = currentQuery; 
                }
            }
            
            // After potential re-render, always call the specific search updater 
            // to handle loading spinners and suggestions dropdown
            updateSearchUI();

            // 3. Render Chat Button/Window
            document.getElementById('chat-button-container').innerHTML = renderChatWindow();
            
            // 4. Render Scanner Modal
            const scannerModal = document.getElementById('scanner-modal');
            scannerModal.innerHTML = renderScannerModal();
            scannerModal.style.display = appState.showScannerModal ? 'flex' : 'none';


            // 5. Update Theme Toggle Icons
            const themeToggle = document.getElementById('theme-toggle');
            const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
            const themeIcon = appState.isDarkMode ? Icons.Sun : Icons.Moon;

            if (themeToggle) themeToggle.innerHTML = themeIcon;
            if (mobileThemeToggle) mobileThemeToggle.innerHTML = themeIcon;

             // 6. Scroll to bottom of chat if open
            if (appState.isChatOpen) {
                const chatWindow = document.getElementById('chat-window');
                if (chatWindow) {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // Initial dark mode setup based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                appState.isDarkMode = true;
            } else {
                 appState.isDarkMode = false;
            }
            
            // Initial render
            updateUI();

            // Setup theme toggle listeners (must be done after initial render)
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('mobile-theme-toggle').addEventListener('click', toggleTheme);
        };
    </script>
</body>
</html>